<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATA</title>
    <link rel="stylesheet" href="leader.css">
    <link rel="stylesheet" href="backgroud.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        /* 重置一些默认的样式，确保各浏览器表现一致 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            list-style: none;
            text-decoration: none;
        }

        /* 设置 body 的背景颜色 */
        body {
            font-family: Arial, sans-serif;
            background: #e4e9f5;
        }

        a {
            text-decoration: none;
            color: #fdfdfd;
        }

        /* 更新 .content 类来实现内容居中 */
        .content {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: url('background.png') no-repeat center center;
            background-size: cover;
            text-shadow: none;
            color: #030303;
            padding: 20px;
            box-sizing: border-box;
            transition: left 0.5s, width 0.5s;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            padding: 20px;
        }

        h2 {
            color: #333;
            text-align: center;
        }

        form {
            background: #f9f9f9;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .form-label {
            font-weight: bold;
            color: #555;
        }

        select,
        input[type="date"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            margin-top: 5px;
        }

        button[type="button"] {
            background-color: #007bff;
            border: none;
            padding: 15px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            width: 100%;
        }

        button[type="button"]:hover {
            background-color: #0056b3;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .col-md-4,
        .col-md-6 {
            flex: 1;
            min-width: 220px;
        }

        .col-md-12 {
            flex: 1;
            min-width: 460px;
        }

        .d-grid {
            text-align: center;
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 100000000;
            left: 0;
            top: 0;
            width: 100%;
            /* width: calc(100% - 240px); */
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        
        .modal-content {
            background-color: white;
            
            /* background-color:transparent; */
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }



        .modal-close {
            float: right;
            cursor: pointer;
            font-size: 40px;
            color: red;
        }

        .table-container {
            margin-top: 20px;
            overflow-x: auto;
            color: #000000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        #downloadBtn {
            margin-top: 20px;
            background-color: #28a745;
            border: none;
            padding: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #downloadBtn:hover {
            background-color: #218838;
        }
    </style>
</head>

<body>
    <!-- 侧边栏容器 -->
    <div class="shell">
        <!-- 导航列表 -->
        <ul class="nav">
            <!-- 激活的导航项 -->
            <li class="active" id="logo">
                <a href="query.html">
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt="">
                        </div>
                    </div>
                    <div class="text">数据查询</div>
                </a>
            </li>
            <!-- 导航列表项 -->
            <li>
                <a href="main.html">
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt="">
                        </div>
                    </div>
                    <div class="text">WELCOME</div>
                </a>
            </li>
            <li>
                <a href="applicable.html">
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt=""> <!-- 显示头像图片 -->
                        </div>
                    </div>
                    <div class="text">适用场景</div> <!-- 链接的文本部分 -->
                </a>
            </li>
            <!-- 其他导航项 -->
            <li>
                <a href="introduction.html">
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt=""> <!-- 显示头像图片 -->
                        </div>
                    </div>
                    <div class="text">产品介绍</div> <!-- 链接的文本部分 -->
                </a>
            </li>
            <li>
                <a href="file.html">
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt=""> <!-- 显示头像图片 -->
                        </div>
                    </div>
                    <div class="text">我的文件</div> <!-- 链接的文本部分 -->
                </a>
            </li>
            <li>
                <a href="algorithm.html">
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt="">
                        </div>
                    </div>
                    <div class="text">数据分析</div>
                </a>
            </li>
            <li>
                <a href="ai.html">
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt="">
                        </div>
                    </div>
                    <div class="text">AI</div>
                </a>
            </li>
            <li>
                <a href="#" id="conditionalLink"> 
                    <div class="icon">
                        <div class="imageBox">
                            <img src="logo.webp" alt="">
                        </div>
                    </div>
                    <div class="text">ME</div>
                </a>
            </li>
        </ul>
    </div>
    <!-- 主体内容部分 -->
    <section class="content">
        <div class="container mt-5">
            <h2 class="text-center mb-4">数据查询</h2>
            <form id="queryForm">
                <!-- 表单内容 -->
                <div class="form-row mb-4">
                    <div class="col-md-6">
                        <label for="provinceSelect">省份</label>
                        <select class="form-control" id="provinceSelect" name="province">
                            <option value="">选择省份</option>
                            <!-- 手动填充省份选项 -->
                            <option value="1">福建</option>
                            <!-- 其他省份 -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="regionSelect">地区</label>
                        <select class="form-control" id="regionSelect" name="region" disabled>
                            <option value="">选择地区</option>
                        </select>
                    </div>
                </div>
                <div class="form-row mb-4">
                    <div class="col-md-6">
                        <label for="categorySelect">类目</label>
                        <select class="form-control" id="categorySelect" name="category" disabled>
                            <option value="">选择类目</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="subCategorySelect">细目</label>
                        <select class="form-control" id="subCategorySelect" name="subcategory" disabled>
                            <option value="">选择细目</option>
                        </select>
                    </div>
                </div>
                <div class="form-row mb-4">
                    <div class="col-md-6">
                        <label for="startTime">起始时间</label>
                        <select class="form-control" id="startTime" name="startTime" disabled>
                            <option value="">选择起始时间</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="endTime">终止时间</label>
                        <select class="form-control" id="endTime" name="endTime" disabled>
                            <option value="">选择终止时间</option>
                        </select>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="button" class="btn btn-primary" onclick="submitQuery()">查询</button>
                </div>
            </form>
        </div>
    </section>
    <div id="file-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="close-modal">&times;</span>
            <div id="table-container" class="table-container">
                <!-- 表格内容将显示在此处 -->
            </div>
            <button id="downloadBtn" onclick="downloadTableAsExcel()">下载表格</button>
        </div>
    </div>
    <script>
        const link = document.getElementById("conditionalLink");
        // 添加点击事件监听器
        link.addEventListener("click", function(event) {
            // event.preventDefault(); 

            // 检查 sessionStorage 中是否存在登录 token
            const token = sessionStorage.getItem("authToken");

            if (token) {
                // 如果存在 token，则跳转到主页
                window.location.href = "homepage.html";
            } else {
                // 如果不存在 token，则跳转到登录页面
                window.location.href = "me.html";
            }
        });
        // 当页面加载时，检查登录状态
        document.addEventListener("DOMContentLoaded", function () {
            checkLoginStatus();
        });
        // 检查用户是否已登录的函数
        function checkLoginStatus() {
            const token = sessionStorage.getItem("authToken");
            if (!token) {
                // 如果没有 token，则跳转回登录页面
                window.location.href = "me.html"; 
            }
        }

        $(document).ready(function () {
            // 获取地区数据
            $('#provinceSelect').change(function () {
                const provinceId = $(this).val();
                $('#regionSelect').empty().append(new Option('选择地区', '')).prop('disabled', !provinceId);
                $('#categorySelect').empty().append(new Option('选择类目', '')).prop('disabled', true);
                $('#subCategorySelect').empty().append(new Option('选择细目', '')).prop('disabled', true);

                if (provinceId) {
                    $.ajax({
                        url: 'http://127.0.0.1:7077/query/region',
                        method: 'POST',
                        data: JSON.stringify({ province_id: provinceId }), // 发送 province_id 参数
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.message === "success" && Array.isArray(response.data)) {
                                response.data.forEach(function (region) {
                                    $('#regionSelect').append(new Option(region.region_name, region.region_id));
                                });
                                $('#regionSelect').prop('disabled', false);
                            } else {
                                alert('未找到地区数据');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("获取地区失败:", error);
                            alert('获取地区失败，请检查后端配置。');
                        }
                    });
                }
            });

            // 根据所选地区获取顶级类目
            $('#regionSelect').change(function () {
                const regionId = $(this).val();
                $('#categorySelect').empty().append(new Option('选择类目', '')).prop('disabled', !regionId);
                $('#subCategorySelect').empty().append(new Option('选择细目', '')).prop('disabled', true);

                if (regionId) {
                    $.ajax({
                        url: 'http://127.0.0.1:7077/query/top_category',
                        method: 'POST',
                        data: JSON.stringify({ region_id: regionId }),
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.message === "success" && Array.isArray(response.data)) {
                                response.data.forEach(function (category) {
                                    $('#categorySelect').append(new Option(category.category_name, category.category_id));
                                });
                                $('#categorySelect').prop('disabled', false);
                            } else {
                                alert('未找到类目数据');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("获取类目失败:", error);
                            alert('获取类目失败，请检查后端配置。');
                        }
                    });
                }
            });

            // 根据所选顶级类目获取子类目
            $('#categorySelect').change(function () {
                const categoryId = $(this).val();
                $('#subCategorySelect').empty().append(new Option('选择细目', '')).prop('disabled', !categoryId);

                if (categoryId) {
                    $.ajax({
                        url: 'http://127.0.0.1:7077/query/sub_category',
                        method: 'POST',
                        data: JSON.stringify({ category_id: categoryId }),
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.message === "success" && Array.isArray(response.data)) {
                                response.data.forEach(function (subcategory) {
                                    $('#subCategorySelect').append(new Option(subcategory.category_name, subcategory.category_id));
                                });
                                $('#subCategorySelect').prop('disabled', false);
                            } else {
                                alert('未找到子类目数据');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("获取子类目失败:", error);
                            alert('获取子类目失败，请检查后端配置。');
                        }
                    });
                }
            });

            // 获取年份数据
            $('#subCategorySelect').change(function () {
                const subCategoryId = $(this).val();

                if (subCategoryId) {
                    $.ajax({
                        url: 'http://127.0.0.1:7077/query/available_year',
                        method: 'POST',
                        data: JSON.stringify({ category_id: subCategoryId }), // 使用子类目的 category_id 作为参数
                        contentType: 'application/json',
                        success: function (response) {
                            // 检查后端返回的数据结构
                            if (response.message === "success" && Array.isArray(response.years)) {
                                // 清空并填充 startTime 和 endTime 下拉框
                                $('#startTime').empty().append(new Option('选择起始时间', ''));
                                $('#endTime').empty().append(new Option('选择终止时间', ''));

                                response.years.forEach(function (year) {
                                    $('#startTime').append(new Option(year, year));
                                    $('#endTime').append(new Option(year, year));
                                });

                                // 启用年份选择框
                                $('#startTime').prop('disabled', false);
                                $('#endTime').prop('disabled', false);
                            } else {
                                alert('没有可用年份数据');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("获取年份失败:", error);
                            alert('获取年份失败，请检查后端配置。');
                        }
                    });
                }
            });

            // 关闭弹窗
            $('#close-modal').click(function () {
                $('#file-modal').hide();
            });
        });

        // 提交查询请求，获取数据表
        function submitQuery() {
            const categoryId = $('#subCategorySelect').val();
            const startYear = parseInt($('#startTime').val(), 10);
            const endYear = parseInt($('#endTime').val(), 10);

            if (categoryId && startYear && endYear) {
                // 生成年份数组
                const years = [];
                for (let year = startYear; year <= endYear; year++) {
                    years.push(year.toString());
                }

                $.ajax({
                    url: 'http://127.0.0.1:7077/query/data',
                    method: 'POST',
                    data: JSON.stringify({
                        category_id: categoryId,
                        years: years
                    }),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.message === "success" && Array.isArray(response.data)) {
                            document.getElementById('file-modal').style.display = 'flex';
                            displayDataInTable(response.data);
                            $('#file-modal').show();
                        } else {
                            alert('没有可用数据');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("获取数据表失败:", error);
                        alert('查询失败，请检查后端配置。');
                    }
                });
            } else {
                alert('请选择子类目和年份范围');
            }
        }
        // 显示数据表格在弹窗中
        function displayDataInTable(data) {
            const tableContainer = document.getElementById('table-container');
            tableContainer.innerHTML = ''; // 清空容器内容

            // 创建表格元素
            const table = document.createElement('table');
            table.id = 'dataTable';

            // 生成表头
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = Object.keys(data[0]);
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            // 生成表格主体
            const tbody = table.createTBody();
            data.forEach(rowData => {
                const row = tbody.insertRow();
                headers.forEach(header => {
                    const cell = row.insertCell();
                    cell.textContent = rowData[header];
                });
            });

            // 将表格添加到弹窗内容容器中
            tableContainer.appendChild(table);
        }

        // 下载表格为 Excel 文件
        function downloadTableAsExcel() {
            const tableElement = document.getElementById('dataTable');
            const workbook = XLSX.utils.table_to_book(tableElement, { sheet: "Sheet 1" });
            XLSX.writeFile(workbook, '查询结果.xlsx');
        }

        // 获取所有的导航列表项
        let nav = document.querySelectorAll(".nav li");

        // 定义一个函数，用于激活点击的导航项
        function activeLink() {
            // 移除所有导航项的激活状态
            nav.forEach((item) => item.classList.remove("active"));
            // 给当前点击的导航项添加激活状态
            this.classList.add("active");
        }

        // 给每个导航项添加点击事件监听器，点击时执行 activeLink 函数
        nav.forEach((item) => item.addEventListener("click", activeLink));

        

    </script>
</body>

</html>

